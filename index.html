<!doctype html>
<html>
<head>
	<!-- real scale on mobile -->
	<meta name="viewport" content="width=device-width, user-scalable=no">

	<svg height="0px" width="0px">
		<defs>
			#ffffff
			<filter id="BlueFilter">
				<!-- keep that first line! https://stackoverflow.com/a/39335132/355753 -->
				<feColorMatrix type="matrix" values="0.5 0 0 0 0
				0 0.5 0 0 0
				0 0 1 0 0
				0 0 0 1 0"/>
			</filter>
		</defs>
	</svg>

	<script src="PopJs/Pop.js"></script>
	<script src="PopJsHtml/HtmlDom.js"></script>
	<script src="PopJsHtml/HtmlRenderer.js"></script>

	<link rel="stylesheet" type="text/css" href="win95.css">

		<style>
			#DynamicDom
			{
				display:	block;
				position:	relative;
				width:		50vw;
				height:		50vh;
				xbackground:	black;
			}
		
		.xxx
		{
			background:red;
		}
		</style>
		
</head>
<body>
<audio id="StartupSound" src="Icons/tada.mp3"></audio>


<div id="DynamicDom"></div>


<div class=Window>
<div class=TitleBar><div class=TitleIcon>X</div><div class=TitleText>Test Window</div><div class=Button>_</div><div class=Button>X</div></div>
<div class=MenuBar><div class=MenuItem>File</div><div class=MenuItem>Help</div></div>
<div class=IconView>
	<div class=Icon><img src=Icons/folder.png class=IconIcon></img><div class=IconLabel>CartMon.exe</div></div>
	<div class=Icon><img src=Icons/cddrive.png class=IconIcon></img><div class=IconLabel>OtherIcon.exe</div></div>
	<div class=Icon><img src=Icons/recyclefull.png class=IconIcon></img><div class=IconLabel>Hi</div></div>
	<div class=Icon><img src=Icons/networkneighbourhood.png class=IconIcon></img><div class=IconLabel>Hi</div></div>
	<div class=Icon><img src=Icons/help.png class=IconIcon></img><div class=IconLabel>Hi</div></div>
	<div class=Icon><img src=Icons/settings.png class=IconIcon></img><div class=IconLabel>Hi</div></div>
</div>
</div>

<script>
	
	//	have a dom manager
		//	get input, deliver to control
		
	//	render commands
		//	iterate over dom
		//	for every "draw quad", update uniforms (styles)
	
	//	window manager
		//	what is foreground window
		//	foreach window
			//	selected controls (windows has focus+selected)

function TRenderCommand(ElementName)
{
	this.ElementName = ElementName;
	this.Rect = new Math.Rect(0,0,1,1);			//	local to parent
	this.Uniforms = [];
}



//	temp as I just want to play the sound
function PlayStartupSound(Event)
{
	//	if we can't play (probably auto play) then setup an event
	//	gr: this now is setup so whatever event will fire once the session has been interacted with
	//		so we can use mousemove
	let SetupDefferedPlay = function(Exception)
	{
		document.addEventListener("mousemove", PlayStartupSound);
		//document.addEventListener("click", PlayStartupSound);
	};
	
	let Sound = document.getElementById("StartupSound");
	Sound.play().catch(SetupDefferedPlay);
	
	//	unsubscribe
	if ( Event )
		document.removeEventListener( Event.type, PlayStartupSound);
}


Pop.TControl = function(Dom,Name)
{
	this.Name = Name;
}

//	each of these is a control, and has its own drawquad() and uniforms
//	Window
//		TitleBar
//			Icon
//			TitleText
//			X Button
//		MenuBar
//			File menu
//			Help menu
//		IconView
//			Icon
Pop.TWindow = function(Dom,Name)
{
	Pop.TControl.apply(this,arguments);
	
	let DomElement = Dom.CreateElement(Name);
	DomElement.Control = this;
	//this.TitleBar = new Pop.TTitleBar(Dom,Name+"_TitleBar");
	
	this.GetRenderCommands = function(ParentRect,Element)
	{
		let WindowCmd = new TRenderCommand( Element.Name );
		WindowCmd.Rect = ParentRect;
		WindowCmd.Shader = 'Window';
		
		let Padding = 4;
		let TitleBarHeight = 18;
		//Debug("ParentRect = " + JSON.stringify(ParentRect));
		let PaddedRects = ParentRect.Split( Padding, 1, 1 );
		
		PaddedRects = [PaddedRects[0]];
		PaddedRects[0].h = TitleBarHeight;

		let TitleBarCmds = [];
		let MakeTitleBarCmd = function(PaddedRect,Index)
		{
			let TitleBarCmd = new TRenderCommand( Element.Name + '_TitleBar'+Index );
			Debug("PaddedRect = " +JSON.stringify(PaddedRect) );
			TitleBarCmd.Rect = PaddedRect;
			TitleBarCmd.Shader = 'TitleBar';
			//	override the current CSS for the non-dynamic stuff
			TitleBarCmd.Uniforms['padding'] = 0;
			
			TitleBarCmds.push( TitleBarCmd );
		}
		PaddedRects.forEach(MakeTitleBarCmd);
		return [WindowCmd].concat( TitleBarCmds );;
	}
}




//	in theory, we can swap these so Dom can become an arbirtry renderer for a GL component
//	or we can stream render commands
var Renderer = new Pop.HtmlRenderer('DynamicDom');
var Dom = new Pop.HtmlDom();
var Debug = Pop.Debug;

var HelloWindow = null;

function Init()
{
	PlayStartupSound();
	
	//HelloWindow = new Pop.TWindow(Dom,'Hello!');
	
	Renderer.OnUpdate = Update;
}


function Update()
{
	let WindowElement = Dom.GetElement(HelloWindow.Name);
	WindowElement.Private.Rect.x += 1;
	
	let RenderCommands = Dom.GetRenderCommands();
	//Debug("got RenderCommands x" + RenderCommands.length);
	Renderer.Render( RenderCommands );
}

Init();

</script>

</body>
